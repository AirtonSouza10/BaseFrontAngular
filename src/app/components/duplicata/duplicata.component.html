<div class="form-container">
  <h2>Conta a pagar</h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- DADOS DA DUPLICATA -->
    <div class="form-section">
      <h3>Dados da conta a pagar</h3>
      <div class="toast-container">
        <div *ngIf="sucessoMsg" class="toast toast-success">
          {{ sucessoMsg }}
        </div>

        <div *ngIf="erroMsg" class="toast toast-error">
          {{ erroMsg }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group flex-2">
          <label>Descrição</label>
          <input type="text" formControlName="descricao" required />
        </div>
        <div class="form-group flex-1">
          <label>Valor</label>
          <input type="text" formControlName="valor" step="0.01" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label>Desconto</label>
          <input type="text" formControlName="desconto" step="0.01" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label>Multa</label>
          <input type="text" formControlName="multa" step="0.01" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label>Juros</label>
          <input type="text" formControlName="juros" step="0.01" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label>Valor Total</label>
          <input type="text" formControlName="valorTotal" step="0.01" currencyMask [options]="currencyOptions" readonly />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group flex-2">
          <label>Forma de Pagamento</label>
          <select formControlName="formaPagamentoId" (change)="onFormaPagamentoChange($any($event.target).value)">
            <option [ngValue]="null">Selecione</option>
            <option *ngFor="let f of formasPagamento" [ngValue]="f.id">{{ f.descricao }}</option>
          </select>
        </div>
        <div class="form-group flex-1">
          <label>Quantidade de Parcelas</label>
          <input type="number" formControlName="quantidadeParcelas" readonly />
        </div>
        <div class="form-group flex-1">
          <label>Data Primeira Parcela</label>
          <input type="date" formControlName="dtPrimeiraParcela" />
        </div>
        <div class="form-group flex-1">
          <label>Intervalo (dias)</label>
          <input type="number" formControlName="intervaloDias" readonly />
        </div>
      </div>
    </div>

    <!-- PARCELAS -->
    <div class="form-section" *ngIf="parcelas.length > 0">
      <h3>Parcelas</h3>
      <div formArrayName="parcelas" class="parcelas-grid">
        <div *ngFor="let parc of parcelas.controls; let i=index" [formGroupName]="i" class="parcela-card">
          <div class="parcela-header">Parcela {{ i + 1 }} / {{ parcelas.length }}</div>
          <div class="form-row">
            <div class="form-group flex-1">
              <label>Número da Parcela</label>
              <input type="text" formControlName="numeroParcela" />
            </div>
            <div class="form-group flex-2">
              <label>Data Vencimento</label>
              <input type="date" formControlName="dtVencimento" />
            </div>
            <div class="form-group flex-2">
              <label>Valor</label>
              <input type="text" formControlName="valorTotal" step="0.01" currencyMask [options]="currencyOptions" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NOTAS ASSOCIADAS -->
    <div class="form-section" *ngIf="notasAssociadas.length" class="notas-associadas">
      <h3>Notas associadas</h3>
      <ul>
        <li *ngFor="let nota of notasAssociadas; let i = index">
          {{ nota.numero }} - {{ nota.fornecedorNome }} - {{ nota.valorTotal | currency:'BRL':'symbol':'1.2-2'}}
          <button type="button" class="btn-remove" (click)="removerNota(i)">Remover</button>
        </li>
      </ul>
    </div>

    <!-- BOTÃO ADICIONAR NOTA FISCAL E VALOR RESTANTE -->
    <div class="form-actions" style="display: flex; align-items: center; gap: 1rem;">
      <button type="button" class="btn-submit" (click)="abrirModalNota()">Vincular Nota Fiscal</button>
      <button type="button" class="btn-submit" (click)="abrirModalNovaNota()">Adicionar Nova Nota</button>

      <div class="valor-restante-container">
        <label>Valor restante:</label>
        <input type="text"
              [value]="valorRestanteNotas | currency:'BRL':'symbol':'1.2-2'"
              [ngClass]="{'faltando': valorRestanteNotas > 0, 'ok': valorRestanteNotas <= 0}"
              readonly />
      </div>
    </div>

    <!-- AÇÕES -->
    <div class="form-actions">
      <button type="submit" class="btn-submit"[disabled]="!form.valid">{{ editando ? 'Atualizar' : 'Salvar' }}</button>
      <button *ngIf="editando" type="button" class="btn-remove" (click)="cancelarEdicao()">Cancelar</button>
    </div>
  </form>

  <!-- MODAL NOTA FISCAL -->
  <div class="modal" *ngIf="modalNotaAberto">
    <div class="modal-content">
      <h3>Buscar Nota Fiscal</h3>

      <div class="form-row">
        <div class="form-group flex-1">
          <label>Número</label>
          <input type="number" [(ngModel)]="numeroNota" />
        </div>

        <div class="form-group flex-2" style="position: relative;">
          <label>Fornecedor</label>
          <input type="text"
                 placeholder="Digite nome ou identificação"
                 [(ngModel)]="fornecedorInput"
                 (focus)="abrirAutocomplete()"
                 (input)="filtrarFornecedores()"
                 (blur)="validarFornecedor()"
                 autocomplete="off" />

          <ul *ngIf="fornecedoresFiltrados.length" class="autocomplete-list">
            <li *ngFor="let f of fornecedoresFiltrados" (mousedown)="selecionarFornecedor(f)">
              {{ f.nome }} - {{ f.identificacao }}
            </li>
          </ul>
        </div>

        <div class="form-group flex-1">
          <button type="button" class="btn-submit" (click)="buscarNota()">Buscar</button>
        </div>
        <div class="form-group flex-1">
        </div>
      </div>

      <div *ngIf="notasEncontradas.length">
        <p><strong>Notas encontradas:</strong></p>
        <div class="notas-encontradas-list">
          <div *ngFor="let nota of notasEncontradas" class="nota-item">
            {{ nota.numero }} - {{ nota.serie }} - {{ nota.chave }}
            <button type="button" class="btn-submit" (click)="adicionarNotaNaDuplicata(nota)">Adicionar</button>
          </div>
        </div>
      </div>

      <button type="button" class="btn-remove" (click)="fecharModalNota()">Fechar</button>
    </div>
  </div>

  <!-- MODAL ADICIONAR NOVA NOTA -->
  <div class="modal-nova-nota" *ngIf="modalNovaNotaAberto">
    <div class="modal-content">
      <h3>Adicionar Nova Nota Fiscal</h3>

      <app-nota-fiscal [isModal]="true" (notaCriada)="adicionarNovaNota($event)"></app-nota-fiscal>

      <button type="button" class="btn-remove" (click)="fecharModalNovaNota()">Fechar</button>
    </div>
  </div>

  <!-- FILTRO E PAGINAÇÃO -->
  <div class="filtro-container" style="margin-top: 20px; display: flex; gap: 10px;">
    <input type="text" [(ngModel)]="filtroDescricao" placeholder="Filtrar por descrição" />
    <button type="button" class="btn-filter" (click)="aplicarFiltro()">Filtrar</button>
    <button type="button" class="btn-limpar" (click)="limparFiltro()">Limpar</button>
  </div>

  <!-- TABELA DE DUPLICATAS -->
  <table class="tabela-tipos" *ngIf="duplicatas.length">
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Valor Total</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let d of duplicatas">
        <td>{{ d.descricao }}</td>
        <td>{{ d.valorTotal | currency:'BRL' }}</td>
        <td>
          <div class="acoes-tabela">
            <button type="button" class="btn-submit" (click)="editarDuplicata(d)">Editar</button>
            <button type="button" class="btn-remove" (click)="excluirDuplicata(d.id)">Excluir</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- CONTROLES DE PAGINAÇÃO -->
  <div class="paginacao" *ngIf="totalPages > 1">
    <button type="button" (click)="mudarPagina(currentPage - 1)" [disabled]="currentPage === 0">« Anterior</button>
    <ng-container *ngFor="let i of [].constructor(totalPages); let idx = index">
      <button type="button" [class.active]="idx === currentPage" (click)="mudarPagina(idx)">{{ idx + 1 }}</button>
    </ng-container>
    <button type="button" (click)="mudarPagina(currentPage + 1)" [disabled]="currentPage + 1 >= totalPages">Próxima »</button>
  </div>
</div>
