<div class="form-container">
  <h2 *ngIf="!isModal">Nota Fiscal</h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- DADOS DA NOTA FISCAL -->
    <div class="form-section">
      <h3>Dados da Nota Fiscal</h3>

      <div class="form-row">
        <div class="form-group flex-1">
          <label for="numero">N√∫mero<span class="text-danger">*</span></label>
          <input id="numero" formControlName="numero" type="text" maxlength="20" required />
        </div>
        <div class="form-group flex-1">
          <label for="serie">S√©rie<span class="text-danger">*</span></label>
          <input id="serie" formControlName="serie" maxlength="5" type="text" />
        </div>
        <div class="form-group flex-3">
          <label for="chave">Chave<span class="text-danger">*</span></label>
          <input id="chave" formControlName="chave" type="text" maxlength="44" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group flex-2">
          <label for="descricaoObs">Observa√ß√£o</label>
          <input id="descricaoObs" formControlName="descricaoObs" type="text" maxlength="500" />
        </div>
        <div class="form-group flex-1" style="position: relative;">
          <label for="duplicataInput">Duplicata</label>
          <div style="display: flex; gap: 8px;">
            <input
              id="duplicataInput"
              type="text"
              placeholder="Selecione uma duplicata"
              formControlName="duplicataInput"
              readonly
              autocomplete="off"
            />
            <button type="button" (click)="abrirModalDuplicata()" class="btn btn-secondary">
              üîç
            </button>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group flex-1">
          <label for="valorTotal">Valor Total<span class="text-danger">*</span></label>
          <input id="valorTotal" formControlName="valorTotal" type="text" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label for="valorDesconto">Desconto</label>
          <input id="valorDesconto" formControlName="valorDesconto" type="text" currencyMask [options]="currencyOptions"/>
        </div>
        <div class="form-group flex-1">
          <label for="valorIcms">ICMS</label>
          <input id="valorIcms" formControlName="valorIcms" type="text" currencyMask [options]="currencyOptions" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group flex-1">
          <label for="valorJuros">Juros</label>
          <input id="valorJuros" formControlName="valorJuros" type="text" currencyMask [options]="currencyOptions" />
        </div>
        <div class="form-group flex-1">
          <label for="valorMulta">Multa</label>
          <input id="valorMulta" formControlName="valorMulta" type="text" currencyMask [options]="currencyOptions"/>
        </div>
        <div class="form-group flex-1">
          <label for="dtCompra">Data de Compra<span class="text-danger">*</span></label>
          <input id="dtCompra" formControlName="dtCompra" type="date" />
        </div>
      </div>

      <div class="form-row">
        <!-- CAMPO FORNECEDOR COM AUTOCOMPLETE -->
        <div class="form-group flex-1" style="position: relative;">
          <label for="fornecedorInput">Fornecedor<span class="text-danger">*</span></label>
          <input id="fornecedorInput"
                 type="text"
                 placeholder="Digite nome ou identifica√ß√£o"
                 formControlName="fornecedorInput"
                 (focus)="abrirAutocomplete()"
                 (input)="filtrarFornecedores()"
                 (blur)="validarFornecedor()"
                 autocomplete="off" />

          <ul *ngIf="fornecedoresFiltrados.length" class="autocomplete-list">
            <li *ngFor="let f of fornecedoresFiltrados" (mousedown)="selecionarFornecedor(f)">
              {{ f.nome }} - {{ f.identificacao }}
            </li>
          </ul>
        </div>

        <div class="form-group flex-1">
          <label>Tipo Nota<span class="text-danger">*</span></label>
          <select formControlName="tipoNotaId">
            <option [ngValue]="null">Selecione</option>
            <option *ngFor="let t of tiposNota" [ngValue]="t.id">{{ t.descricao }}</option>
          </select>
        </div>
        <div class="form-group flex-1">
          <label>Filial<span class="text-danger">*</span></label>
          <select formControlName="filialId">
            <option [ngValue]="null">Selecione</option>
            <option *ngFor="let f of filiais" [ngValue]="f.id">{{ f.nome }}</option>
          </select>
        </div>
      </div>

      <!-- CHECKBOX GERAR PARCELAS PREVISTAS -->
      <div class="form-row" *ngIf="!isModal">
        <div class="form-group flex-1">
          <label>
            <input type="checkbox" formControlName="gerarParcelasPrevistas" />
            Gerar Parcelas Previstas
          </label>
        </div>
      </div>

      <!-- PARCELAS -->
      <div *ngIf="form.get('gerarParcelasPrevistas')?.value" class="form-row">
        <div class="form-group flex-2">
          <label>Forma de Pagamento</label>
          <select formControlName="formaPagamentoId">
            <option [ngValue]="null">Selecione</option>
            <option *ngFor="let f of formasPagamento" [ngValue]="f.id">{{ f.descricao }}</option>
          </select>
        </div>
        <div class="form-group flex-1">
          <label>Qtde Parcelas</label>
          <input type="number" min="1" formControlName="quantidadeParcelas" />
        </div>
        <div class="form-group flex-1">
          <label>Dt 1¬∫ Parcela</label>
          <input type="date" formControlName="dtPrimeiraParcela" />
        </div>
        <div class="form-group flex-1">
          <label>Intervalo (dias)</label>
          <input type="number" min="1" formControlName="intervaloDias" />
        </div>
        <div class="form-group flex-1" style="align-self:flex-end;">
          <button type="button" (click)="gerarParcelas()">Gerar Parcelas</button>
        </div>
      </div>
    </div>

    <!-- PARCELAS PREVISTAS -->
    <div *ngIf="form.get('gerarParcelasPrevistas')?.value" class="form-section">
      <h3>Parcelas Previstas</h3>
      <div formArrayName="parcelasPrevistas" class="parcelas-grid">
        <div *ngFor="let parc of parcelasPrevistas.controls; let i=index" [formGroupName]="i" class="parcela-card">
          <div class="parcela-header">
            Parcela {{ i + 1 }} / {{ parcelasPrevistas.length }}
          </div>
          <div class="form-row">
            <div class="form-group flex-2">
              <label>Data Vencimento</label>
              <input type="date" formControlName="dtVencimentoPrevisto" />
            </div>
            <div class="form-group flex-2">
              <label>Valor Previsto</label>
              <input type="text" step="0.01" formControlName="valorPrevisto" currencyMask [options]="currencyOptions"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- A√á√ïES -->
    <div class="form-actions">
      <button type="submit" [disabled]="form.invalid" class="btn-submit">
        {{ editando ? 'Atualizar' : 'Salvar' }}
      </button>
      <button *ngIf="editando" type="button" class="btn-remove" (click)="cancelarEdicao()">Cancelar</button>
    </div>
  </form>

  <!-- MENSAGENS -->
  <div *ngIf="sucessoMsg" class="mensagem-sucesso">{{ sucessoMsg }}</div>
  <div *ngIf="erroMsg" class="mensagem-erro">{{ erroMsg }}</div>

<div class="modal-backdrop" *ngIf="modalDuplicataAberto">
  <div class="modal">
    <div class="modal-header">
      <h3>Pesquisar Duplicata</h3>
      <button type="button" (click)="fecharModalDuplicata()">‚úñ</button>
    </div>

    <div class="modal-body">
      <div class="input-pesquisa">
        <input
          type="text"
          placeholder="Digite descri√ß√£o ou n√∫mero"
          [(ngModel)]="filtroModalDuplicata"
        />
        <button type="button" (click)="pesquisarDuplicatas()">üîç Pesquisar</button>
      </div>

      <table *ngIf="duplicatasFiltradasModal.length">
        <thead>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Valor</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of duplicatasFiltradasModal">
            <td>{{ d.descricao }}</td>
            <td>{{ d.valor | currency:'BRL' }}</td>
            <td>
              <button type="button" (click)="selecionarDuplicataModal(d)">Selecionar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="duplicatasFiltradasModal.length === 0 && filtroModalDuplicata">
        Nenhuma duplicata encontrada.
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" (click)="fecharModalDuplicata()">Fechar</button>
    </div>
  </div>
</div>



  <!-- FILTRO DE NOTAS -->
  <div class="filtro-tabela" style="margin: 20px 0; display:flex; gap:10px; align-items:center;">
    <input type="text" placeholder="N√∫mero da Nota" [(ngModel)]="filtroNumero" name="filtroNumero" />
    <select [(ngModel)]="filtroFornecedor" name="filtroFornecedor">
      <option [ngValue]="null">Todos Fornecedores</option>
      <option *ngFor="let f of fornecedores" [ngValue]="f.id">{{ f.nome }}</option>
    </select>
    <button type="button" (click)="aplicarFiltro()">Filtrar</button>
    <button type="button" (click)="limparFiltro()">Limpar</button>
  </div>

  <!-- TABELA DE NOTAS -->
  <table class="tabela-tipos" *ngIf="notasFiscais.length">
    <thead>
      <tr>
        <th>N√∫mero</th>
        <th>S√©rie</th>
        <th>Fornecedor</th>
        <th>Filial</th>
        <th>Valor Total</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let n of notasFiscais">
        <td>{{ n.numero }}</td>
        <td>{{ n.serie }}</td>
        <td>{{ getFornecedorNome(n.fornecedorId) }}</td>
        <td>{{ getFilialNome(n.filialId) }}</td>
        <td>{{ n.valorTotal | currency:'BRL' }}</td>
        <td>
          <div class="acoes-tabela">
            <button type="button" class="btn-submit" (click)="editarNotaFiscal(n)">Editar</button>
            <button type="button" class="btn-remove" (click)="excluirNotaFiscal(n.id)">Excluir</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

<!-- ===================== PAGINA√á√ÉO ===================== -->
<div class="paginacao" *ngIf="totalPages > 1">
    <button (click)="mudarPagina(currentPage - 1)" [disabled]="currentPage === 0">
      ¬´ Anterior
    </button>

    <!-- Primeira p√°gina -->
    <button *ngIf="currentPage > 2" (click)="mudarPagina(0)">1</button>
    <span *ngIf="currentPage > 3">...</span>

    <!-- P√°ginas pr√≥ximas -->
    <ng-container *ngFor="let p of getPaginasVisiveis()">
      <button [class.active]="p === currentPage" (click)="mudarPagina(p)">
        {{ p + 1 }}
      </button>
    </ng-container>

    <span *ngIf="currentPage < totalPages - 4">...</span>

    <!-- √öltima p√°gina -->
    <button *ngIf="currentPage < totalPages - 2" (click)="mudarPagina(totalPages - 1)">
      {{ totalPages }}
    </button>

    <button (click)="mudarPagina(currentPage + 1)" [disabled]="currentPage + 1 >= totalPages">
      Pr√≥xima ¬ª
    </button>
  </div>

</div>
