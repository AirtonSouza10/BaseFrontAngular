<div class="form-container">
  <h2>Usuário</h2>
  <br/>

  <!-- Mensagens -->
  <div *ngIf="sucessoMsg" class="mensagem-sucesso">{{ sucessoMsg }}</div>
  <div *ngIf="erroMsg" class="mensagem-erro">{{ erroMsg }}</div>

  <!-- FORMULÁRIO PRINCIPAL -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()">

    <!-- LINHA 1: Nome + Identificação -->
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Nome</mat-label>
        <input matInput formControlName="nome" maxlength="200" required />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Identificação</mat-label>
        <input matInput formControlName="identificacao" maxlength="14" required />
      </mat-form-field>
    </div>

    <!-- LINHA 2: E-mail + Telefone + Senha -->
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>E-mail</mat-label>
        <input matInput type="email" formControlName="email" required />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Telefone</mat-label>
        <input matInput formControlName="telefone" required />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Senha</mat-label>
        <input matInput type="password" formControlName="senha" maxlength="50"
               [required]="!editandoUsuarioId" />
        <mat-hint end="end">
          {{ form.get('senha')?.value?.length || 0 }}/6
        </mat-hint>
        <mat-error *ngIf="form.get('senha')?.invalid && form.get('senha')?.touched">
          A senha deve ter no mínimo 6 caracteres
        </mat-error>
      </mat-form-field>
    </div>

    <!-- BOTOES -->
    <div class="button-group">
      <button mat-raised-button class="btn-salvar" type="submit" [disabled]="form.invalid">
        {{ editandoUsuarioId ? 'Atualizar' : 'Salvar' }}
      </button>
      <button mat-stroked-button class="btn-cancelar" type="button" *ngIf="editandoUsuarioId" (click)="cancelarEdicao()">
        Cancelar
      </button>
    </div>
  </form>

  <!-- TABELA -->
  <div class="table-container" *ngIf="usuarios.data.length > 0">
    <table mat-table [dataSource]="usuarios" class="mat-elevation-z2">

      <!-- Colunas -->
      <ng-container matColumnDef="nome">
        <th mat-header-cell *matHeaderCellDef>Nome</th>
        <td mat-cell *matCellDef="let u">{{ u.nome }}</td>
      </ng-container>

      <ng-container matColumnDef="identificacao">
        <th mat-header-cell *matHeaderCellDef>Identificação</th>
        <td mat-cell *matCellDef="let u">{{ u.identificacao }}</td>
      </ng-container>

      <ng-container matColumnDef="ativo">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let u">
          <span class="status-badge" [ngClass]="u.ativo ? 'ativo' : 'inativo'">
            {{ u.ativo ? 'Ativo' : 'Inativo' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="acoes">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let u" class="acoes-cell">
          <button mat-icon-button color="accent" matTooltip="Editar" (click)="editarUsuario(u)">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button matTooltip="{{ u.ativo ? 'Inativar' : 'Ativar' }}" (click)="toggleAtivo(u)">
            <mat-icon>{{ u.ativo ? 'toggle_on' : 'toggle_off' }}</mat-icon>
          </button>
          <button mat-icon-button color="primary" matTooltip="Alterar Senha" (click)="abrirModalSenha(u)">
            <mat-icon>lock</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>
</div>

<!-- MODAL ALTERAR SENHA -->
<div class="modal-senha" *ngIf="modalSenhaAberto">
  <div class="modal-content">
    <h3>Alterar Senha</h3>

    <form [formGroup]="senhaForm" (ngSubmit)="alterarSenha()">
      <div class="inputs-wrapper">
        <mat-form-field appearance="outline">
          <mat-label>Senha Antiga</mat-label>
          <input matInput type="password" formControlName="senhaAntiga" required />
          <mat-error *ngIf="senhaForm.get('senhaAntiga')?.invalid && senhaForm.get('senhaAntiga')?.touched">
            A senha antiga é obrigatória
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Nova Senha</mat-label>
          <input matInput type="password" formControlName="novaSenha" maxlength="50" required />
          <mat-hint start="end">{{ senhaForm.get('novaSenha')?.value?.length || 0 }}/6</mat-hint>
          <mat-error *ngIf="senhaForm.get('novaSenha')?.invalid && senhaForm.get('novaSenha')?.touched">
            A nova senha deve ter no mínimo 6 caracteres
          </mat-error>
        </mat-form-field>
      </div>

      <div class="button-group">
        <button mat-raised-button class="btn-alterar" type="submit"
                [disabled]="senhaForm.invalid || senhaForm.get('novaSenha')?.value.length < 6">
          Alterar
        </button>
        <button mat-stroked-button class="btn-cancelar" type="button" (click)="fecharModalSenha()">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
